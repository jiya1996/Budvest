# 指令识别修复说明

## 问题
"购入100股特斯拉" 报错，无法识别

## 已修复
✅ 直接更新了 `/api/portfolio/parse-command/route.ts`

## 修复内容

### 1. OpenAI提示词优化
添加了明确的意图识别词汇表：
- 买入类：买入、**购入**、买、购买、入手、抄底、建仓、加仓、增持、补仓、追涨
- 卖出类：卖出、卖、出售、减仓、清仓、平仓、止损、止盈、获利了结、离场
- 观望类：观望、自选、关注
- 删除类：删除、移除

### 2. Fallback函数增强
扩展了正则表达式匹配的关键词列表，确保即使AI API失败也能识别常用词汇。

## 测试用例

现在应该可以识别以下所有指令：

### 买入类
```
✅ "买入100股特斯拉"
✅ "购入100股特斯拉"  ← 之前报错，现在修复
✅ "入手100股特斯拉"
✅ "抄底100股特斯拉"
✅ "建仓100股特斯拉"
✅ "加仓100股特斯拉"
✅ "追涨100股特斯拉"
```

### 卖出类
```
✅ "卖出特斯拉"
✅ "清仓特斯拉"
✅ "平仓特斯拉"
✅ "止损特斯拉"
✅ "止盈特斯拉"
✅ "获利了结特斯拉"
```

### 观望类
```
✅ "观望特斯拉"
✅ "关注特斯拉"
✅ "加入自选特斯拉"
```

## 验证方法

1. 重启开发服务器（如果正在运行）
2. 在前端输入 "购入100股特斯拉"
3. 应该正确识别为：
   - 股票名称：Tesla
   - 用户意图：用户增持
   - 股数：100

## 备份文件
原文件已备份到：`route.ts.backup`

## 技术细节

### AI模型处理
- 提示词明确列出所有同义词
- 强调"理解语义"而不是关键词匹配
- 温度设置为0.3保证稳定性

### Fallback处理
- 使用数组存储关键词：`['买入', '购入', '买', '购买', ...]`
- 使用 `some()` 方法检查是否包含任意关键词
- 正则表达式支持所有扩展词汇

### 验证机制
- 解析后验证股票名称是否在数据库中
- 统一为标准英文名称（Tesla, Apple等）
- 返回明确错误信息

## 如果仍然报错

请检查：
1. 是否重启了开发服务器
2. 浏览器是否清除了缓存
3. 查看浏览器控制台的错误信息
4. 查看服务器日志的详细错误

如果问题持续，请提供：
- 具体的错误信息
- 浏览器控制台截图
- 服务器日志
