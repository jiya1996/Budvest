# æŠ•èµ„å¿ƒç†å¤ç›˜æµç¨‹

**æµç¨‹ID**: UF-003
**ä¼˜å…ˆçº§**: P0 - Critical
**æ¶‰åŠé¡µé¢**: å¯¹è¯é¡µ â†’ å¤ç›˜å¡ç‰‡ â†’ å¤ç›˜åˆ—è¡¨

---

## æµç¨‹æ¦‚è¿°

å¯¹è¯ç»“æŸåï¼Œç³»ç»Ÿå¼•å¯¼ç”¨æˆ·å®Œæˆ 3 æ­¥ç»“æ„åŒ–å¤ç›˜ï¼ˆæƒ…ç»ªå˜åŒ– â†’ å†³ç­–é€‰æ‹© â†’ æ–‡å­—å¤‡æ³¨ï¼‰ï¼Œå¹¶ç”± AI ç”Ÿæˆå¤ç›˜æ€»ç»“ã€‚

### è®¾è®¡ç›®æ ‡

- âœ… å®Œæˆä»"æƒ…ç»ªè¯†åˆ«"åˆ°"åæ€æˆé•¿"çš„é—­ç¯
- âœ… ç»“æ„åŒ–å¤ç›˜ï¼Œé™ä½è®°å½•é—¨æ§›
- âœ… AI ç”Ÿæˆæ´å¯Ÿï¼Œå¸®åŠ©ç”¨æˆ·æˆé•¿

---

## å®Œæ•´æµç¨‹å›¾

```mermaid
flowchart TB
    Start([è§¦å‘å¤ç›˜]) --> TriggerType{è§¦å‘æ–¹å¼}

    TriggerType -->|æ‰‹åŠ¨| ManualTrigger[ç‚¹å‡»"ğŸ“ è®°å½•"æŒ‰é’®]
    TriggerType -->|è‡ªåŠ¨| AutoTrigger[30åˆ†é’Ÿæ— äº¤äº’]
    TriggerType -->|å¯¹è¯ç»“æŸ| EndTrigger[å¯¹è¯è½®æ•° >= 3]

    ManualTrigger --> ShowCard[æ˜¾ç¤ºå¤ç›˜å¡ç‰‡]
    AutoTrigger --> ShowCard
    EndTrigger --> ShowCard

    ShowCard --> Step1[Step 1: æƒ…ç»ªå˜åŒ–]

    Step1 --> SelectBefore[é€‰æ‹©å¯¹è¯å‰æƒ…ç»ª<br/>1-5 åˆ†æ»‘åŠ¨æ¡]
    SelectBefore --> SelectAfter[é€‰æ‹©å¯¹è¯åæƒ…ç»ª<br/>1-5 åˆ†æ»‘åŠ¨æ¡]
    SelectAfter --> ValidateStep1{æƒ…ç»ªæœ‰å˜åŒ–?}

    ValidateStep1 -->|æœ‰| ShowInsight1[æ˜¾ç¤ºå³æ—¶åé¦ˆ<br/>"æƒ…ç»ªæ”¹å–„äº† 2 åˆ†!"]
    ValidateStep1 -->|æ— | ShowInsight2[æ˜¾ç¤ºé¼“åŠ±<br/>"ä¿æŒç¨³å®šä¹Ÿæ˜¯è¿›æ­¥"]

    ShowInsight1 --> Step2[Step 2: å†³ç­–é€‰æ‹©]
    ShowInsight2 --> Step2

    Step2 --> ShowOptions[æ˜¾ç¤º 4 ä¸ªå†³ç­–é€‰é¡¹]
    ShowOptions --> SelectAction{é€‰æ‹©å†³ç­–}

    SelectAction -->|é”ä»“ ğŸ”’| ActionLock[action = 'lock']
    SelectAction -->|åŠ ä»“ ğŸ“ˆ| ActionAdd[action = 'add']
    SelectAction -->|å‡ä»“ ğŸ“‰| ActionReduce[action = 'reduce']
    SelectAction -->|æ¸…ä»“ ğŸš«| ActionClear[action = 'clear']

    ActionLock --> Step3
    ActionAdd --> Step3
    ActionReduce --> Step3
    ActionClear --> Step3

    Step3[Step 3: æ–‡å­—å¤‡æ³¨] --> InputNote[è¾“å…¥å¤‡æ³¨<br/>å¯é€‰ï¼Œæœ€å¤š 200 å­—]

    InputNote --> Submit[ç‚¹å‡»"å®Œæˆå¤ç›˜"]

    Submit --> CallAPI{{POST /api/review}}

    CallAPI --> APIResult{API å“åº”?}

    APIResult -->|æˆåŠŸ| GenerateSummary{{è°ƒç”¨ AI ç”Ÿæˆæ€»ç»“}}
    APIResult -->|å¤±è´¥| ShowError[æ˜¾ç¤ºé”™è¯¯æç¤º]

    ShowError --> RetryOption{é‡è¯•?}
    RetryOption -->|æ˜¯| CallAPI
    RetryOption -->|å¦| SaveLocal[é™çº§ä¿å­˜åˆ° localStorage]

    GenerateSummary --> ShowSummary[æ˜¾ç¤º AI å¤ç›˜æ€»ç»“]

    ShowSummary --> ShowActions2[æ˜¾ç¤ºåç»­è¡ŒåŠ¨å»ºè®®]

    ShowActions2 --> UserChoice{ç”¨æˆ·é€‰æ‹©}

    UserChoice -->|å…³é—­| CloseCard[å…³é—­å¡ç‰‡]
    UserChoice -->|æŸ¥çœ‹å†å²| GotoHistory[è·³è½¬å¤ç›˜åˆ—è¡¨]
    UserChoice -->|åˆ†äº«| ShareReview[ç”Ÿæˆåˆ†äº«å¡ç‰‡]

    CloseCard --> End([æµç¨‹ç»“æŸ])
    GotoHistory --> End
    ShareReview --> End
    SaveLocal --> End

    style Start fill:#90EE90
    style End fill:#90EE90
    style ShowError fill:#FFB6C1
    style CallAPI fill:#87CEEB
    style GenerateSummary fill:#87CEEB
```

---

## è¯¦ç»†æ­¥éª¤è¯´æ˜

### Step 1: æƒ…ç»ªå˜åŒ–

**UI è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1/3   æƒ…ç»ªå˜åŒ–                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å¯¹è¯å‰ï¼Œä½ çš„æƒ…ç»ªæ˜¯ï¼Ÿ               â”‚
â”‚                                     â”‚
â”‚   ğŸ˜°   ğŸ˜Ÿ   ğŸ˜   ğŸ™‚   ğŸ˜Œ           â”‚
â”‚    1    2    3    4    5           â”‚
â”‚         â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                     â”‚
â”‚  å¯¹è¯åï¼Œä½ çš„æƒ…ç»ªæ˜¯ï¼Ÿ               â”‚
â”‚                                     â”‚
â”‚   ğŸ˜°   ğŸ˜Ÿ   ğŸ˜   ğŸ™‚   ğŸ˜Œ           â”‚
â”‚    1    2    3    4    5           â”‚
â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—              â”‚
â”‚                                     â”‚
â”‚  âœ¨ å¤ªæ£’äº†ï¼æƒ…ç»ªæ”¹å–„äº† 2 åˆ†         â”‚
â”‚                                     â”‚
â”‚              [ä¸‹ä¸€æ­¥ â†’]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è§„åˆ™**:
- é»˜è®¤ä¸é€‰ä¸­ï¼Œå¼ºåˆ¶ç”¨æˆ·åšå‡ºé€‰æ‹©
- æ»‘åŠ¨æ¡å¯ç‚¹å‡»æˆ–æ‹–åŠ¨
- é€‰æ‹©åç«‹å³æ˜¾ç¤ºå³æ—¶åé¦ˆ

---

### Step 2: å†³ç­–é€‰æ‹©

**UI è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2/3   ä½ çš„å†³ç­–                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  è¿™æ¬¡å¯¹è¯åï¼Œä½ å†³å®šï¼Ÿ               â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”’ é”ä»“                    â”‚   â”‚
â”‚  â”‚  ä¸æ“ä½œï¼Œä¿æŒç°æœ‰æŒä»“       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ åŠ ä»“                    â—   â”‚
â”‚  â”‚  å¢åŠ æŒä»“                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“‰ å‡ä»“                    â”‚   â”‚
â”‚  â”‚  å‡å°‘æŒä»“                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸš« æ¸…ä»“                    â”‚   â”‚
â”‚  â”‚  å…¨éƒ¨å–å‡º                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚       [â† ä¸Šä¸€æ­¥]  [ä¸‹ä¸€æ­¥ â†’]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è§„åˆ™**:
- å•é€‰ï¼Œå¿…é¡»é€‰æ‹©ä¸€é¡¹
- ç‚¹å‡»é€‰é¡¹å¡é«˜äº®é€‰ä¸­

---

### Step 3: æ–‡å­—å¤‡æ³¨

**UI è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3/3   è®°å½•æƒ³æ³•                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å†™ä¸‹ä½ çš„æƒ³æ³•ï¼ˆå¯é€‰ï¼‰               â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å†³å®šé•¿æœŸæŒæœ‰ï¼Œä¸çœ‹çŸ­æœŸæ³¢åŠ¨  â”‚   â”‚
â”‚  â”‚ ___________________________â”‚   â”‚
â”‚  â”‚                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          32/200    â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â”‚       [â† ä¸Šä¸€æ­¥]  [å®Œæˆå¤ç›˜ âœ“]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è§„åˆ™**:
- æ–‡å­—å¤‡æ³¨ä¸ºå¯é€‰é¡¹
- æœ€å¤š 200 å­—ï¼Œæ˜¾ç¤ºå­—æ•°ç»Ÿè®¡
- æ”¯æŒæ¢è¡Œ

---

### AI å¤ç›˜æ€»ç»“

**è§¦å‘æ—¶æœº**: ç”¨æˆ·ç‚¹å‡»"å®Œæˆå¤ç›˜"å

**ç”Ÿæˆé€»è¾‘**:

```typescript
const prompt = `
ç”¨æˆ·å®Œæˆäº†ä¸€æ¬¡æŠ•èµ„å¤ç›˜ï¼š
- å¯¹è¯å‰æƒ…ç»ªï¼š${emotionBefore}/5
- å¯¹è¯åæƒ…ç»ªï¼š${emotionAfter}/5
- å†³ç­–ï¼š${action}
- å¤‡æ³¨ï¼š${reflection || 'æ— '}

è¯·ç”Ÿæˆä¸€æ®µç®€çŸ­çš„å¤ç›˜æ€»ç»“ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼Œè‚¯å®šç”¨æˆ·çš„è¿›æ­¥ï¼Œå¹¶ç»™å‡ºä¸€æ¡æˆé•¿å»ºè®®ã€‚
`;
```

**ç¤ºä¾‹è¾“å‡º**:

```
ä½ ä»ç„¦è™‘(2åˆ†)åˆ°ç›¸å¯¹å¹³é™(4åˆ†)ï¼Œè¿™æ˜¯å·¨å¤§çš„è¿›æ­¥ã€‚
ä½ é€‰æ‹©äº†é”ä»“ï¼Œè¯´æ˜ä½ æ­£åœ¨å­¦ä¼šæ§åˆ¶å†²åŠ¨ã€‚
ç»§ç»­ä¿æŒè¿™ä»½ç†æ€§ï¼Œä½ ä¼šæˆä¸ºæ›´å¥½çš„æŠ•èµ„è€…ï¼
```

---

## è§¦å‘æ¡ä»¶

| è§¦å‘æ–¹å¼ | æ¡ä»¶ | ä¼˜å…ˆçº§ |
|---------|------|--------|
| æ‰‹åŠ¨è§¦å‘ | ç‚¹å‡»å¯¹è¯é¡µ"ğŸ“ è®°å½•"æŒ‰é’® | æœ€é«˜ |
| å¯¹è¯ç»“æŸ | å¯¹è¯è½®æ•° >= 3 ä¸”ç”¨æˆ·è¿”å›é¦–é¡µ | ä¸­ |
| è‡ªåŠ¨æç¤º | 30 åˆ†é’Ÿæ— äº¤äº’ï¼ˆä»…é¦–æ¬¡ï¼‰ | ä½ |

---

## è¾¹ç•Œæ¡ä»¶å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| ç”¨æˆ·ä¸­é€”é€€å‡º | è‡ªåŠ¨ä¿å­˜è‰ç¨¿åˆ° localStorage |
| ç½‘ç»œæ–­å¼€ | æ•°æ®ä¿å­˜åˆ° localStorageï¼Œç½‘ç»œæ¢å¤ååŒæ­¥ |
| è·³è¿‡æƒ…ç»ªé€‰æ‹© | ç¦æ­¢è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œæç¤º"è¯·é€‰æ‹©æƒ…ç»ª" |
| å¤‡æ³¨è¶…è¿‡ 200 å­— | ç¦æ­¢ç»§ç»­è¾“å…¥ï¼Œæ˜¾ç¤ºå­—æ•°é™åˆ¶ |
| AI æ€»ç»“ç”Ÿæˆå¤±è´¥ | æ˜¾ç¤ºé»˜è®¤é¼“åŠ±è¯­ï¼Œä¸é˜»å¡ä¿å­˜ |

---

## åŸ‹ç‚¹äº‹ä»¶

| äº‹ä»¶ | è§¦å‘æ—¶æœº | å±æ€§ |
|------|---------|------|
| `review_started` | æ‰“å¼€å¤ç›˜å¡ç‰‡ | `{ trigger_type, session_id }` |
| `review_step_completed` | å®Œæˆæ¯ä¸€æ­¥ | `{ step, value }` |
| `review_submitted` | æäº¤å¤ç›˜ | `{ emotion_change, action, has_note }` |
| `review_summary_shown` | æ˜¾ç¤º AI æ€»ç»“ | `{ summary_length }` |
| `review_abandoned` | ä¸­é€”æ”¾å¼ƒ | `{ last_step }` |

---

## éªŒæ”¶æ ‡å‡†æ˜ å°„

| AC ID | æµç¨‹èŠ‚ç‚¹ | éªŒè¯æ–¹å¼ |
|-------|---------|---------|
| AC-003.1 | ManualTrigger | å¯¹è¯é¡µæœ‰"è®°å½•"æŒ‰é’® |
| AC-003.2 | AutoTrigger | 30 åˆ†é’Ÿè®¡æ—¶å™¨è§¦å‘ |
| AC-003.3 | Step1 | 1-5 åˆ†æ»‘åŠ¨æ¡å¯ç”¨ |
| AC-003.4 | Step2 | 4 ä¸ªå†³ç­–é€‰é¡¹å¯é€‰ |
| AC-003.5 | Step3 | 200 å­—é™åˆ¶ç”Ÿæ•ˆ |
| AC-003.6 | GenerateSummary | AI ç”Ÿæˆæ€»ç»“æ–‡æœ¬ |
| AC-003.7 | CallAPI | æ•°æ®å†™å…¥ Supabase |
| AC-003.8 | GotoHistory | å†å²åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º |

---

**æœ€åæ›´æ–°**: 2026-01-21
**å‚è€ƒæ–‡æ¡£**: [Functional Requirements FR-003](../../specs/requirements/functional-requirements.md#fr-003)
