# AI æƒ…ç»ªæ•™ç»ƒå¯¹è¯æµç¨‹

**æµç¨‹ID**: UF-002
**ä¼˜å…ˆçº§**: P0 - Critical
**æ¶‰åŠé¡µé¢**: é¦–é¡µ â†’ å¯¹è¯é¡µ

---

## æµç¨‹æ¦‚è¿°

ç”¨æˆ·ä¸ AI æƒ…ç»ªæ•™ç»ƒè¿›è¡Œå¤šè½®å¯¹è¯ï¼ŒAI èƒ½è¯†åˆ«ç”¨æˆ·æƒ…ç»ªå¹¶æä¾›æ¸©æš–ã€å…±æƒ…çš„å›åº”ã€‚å¯¹è¯ç»“æŸåå¯è§¦å‘å¤ç›˜æµç¨‹ã€‚

### è®¾è®¡ç›®æ ‡

- âœ… å¿«é€Ÿè¿›å…¥å¯¹è¯ï¼Œé™ä½ä½¿ç”¨é—¨æ§›
- âœ… AI è¯†åˆ«æƒ…ç»ªå¹¶å…±æƒ…å›åº”
- âœ… ä¸¥æ ¼ç¦æ­¢æŠ•èµ„æ“ä½œå»ºè®®
- âœ… å¯¹è¯å†å²æŒä¹…åŒ–å­˜å‚¨

---

## å®Œæ•´æµç¨‹å›¾

```mermaid
flowchart TB
    Start([ç”¨æˆ·ç‚¹å‡»"å¼€å§‹å¯¹è¯"]) --> CheckAuth{æ£€æŸ¥ç”¨æˆ·çŠ¶æ€}

    CheckAuth -->|å·²ç™»å½•/Guest| LoadChat[åŠ è½½å¯¹è¯é¡µé¢]
    CheckAuth -->|æœªåˆå§‹åŒ–| Redirect[è·³è½¬ Onboarding]

    LoadChat --> LoadHistory{{åŠ è½½å†å²å¯¹è¯<br/>GET /api/chat/history}}

    LoadHistory --> ShowUI[æ˜¾ç¤ºå¯¹è¯ç•Œé¢]

    ShowUI --> WaitInput[ç­‰å¾…ç”¨æˆ·è¾“å…¥]

    WaitInput --> UserType[ç”¨æˆ·è¾“å…¥æ¶ˆæ¯]

    UserType --> Validate{è¾“å…¥éªŒè¯}

    Validate -->|ç©ºæ¶ˆæ¯| ShowError1[æç¤º"è¯·è¾“å…¥å†…å®¹"]
    Validate -->|è¶…é•¿| ShowError2[æç¤º"æ¶ˆæ¯è¿‡é•¿"]
    Validate -->|æ­£å¸¸| SetLoading[è®¾ç½®åŠ è½½çŠ¶æ€]

    ShowError1 --> WaitInput
    ShowError2 --> WaitInput

    SetLoading --> AddUserMsg[æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° UI]

    AddUserMsg --> CallAPI{{è°ƒç”¨ API<br/>POST /api/chat}}

    CallAPI --> APIResult{API å“åº”?}

    APIResult -->|æˆåŠŸ| ParseResponse[è§£æå“åº”<br/>ChatResponse]
    APIResult -->|å¤±è´¥| HandleError[æ˜¾ç¤ºé”™è¯¯æç¤º]
    APIResult -->|è¶…æ—¶| HandleTimeout[æ˜¾ç¤º"è¯·æ±‚è¶…æ—¶"]

    HandleError --> RetryOption{ç”¨æˆ·é€‰æ‹©}
    HandleTimeout --> RetryOption

    RetryOption -->|é‡è¯•| CallAPI
    RetryOption -->|å–æ¶ˆ| RemoveMsg[ç§»é™¤å¤±è´¥æ¶ˆæ¯]

    RemoveMsg --> WaitInput

    ParseResponse --> DisplayReply[æ˜¾ç¤º AI å›å¤]

    DisplayReply --> ShowActions[æ˜¾ç¤ºå»ºè®®è¡ŒåŠ¨]

    ShowActions --> UpdateEmotion[æ›´æ–°æƒ…ç»ªæ ‡ç­¾]

    UpdateEmotion --> SaveLocal[ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜]

    SaveLocal --> CheckReview{å¯¹è¯è½®æ•° >= 3?}

    CheckReview -->|æ˜¯| ShowReviewHint[æ˜¾ç¤º"è®°å½•å¤ç›˜"æç¤º]
    CheckReview -->|å¦| WaitInput

    ShowReviewHint --> UserChoice{ç”¨æˆ·é€‰æ‹©}

    UserChoice -->|ç»§ç»­å¯¹è¯| WaitInput
    UserChoice -->|å¼€å§‹å¤ç›˜| TriggerReview[è·³è½¬å¤ç›˜æµç¨‹]
    UserChoice -->|å…³é—­æç¤º| WaitInput

    TriggerReview --> End([è¿›å…¥å¤ç›˜æµç¨‹])

    style Start fill:#90EE90
    style End fill:#90EE90
    style HandleError fill:#FFB6C1
    style HandleTimeout fill:#FFB6C1
    style CallAPI fill:#87CEEB
    style LoadHistory fill:#87CEEB
```

---

## åœºæ™¯åˆ†è§£

### åœºæ™¯ 1: æ­£å¸¸å¯¹è¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant A as API
    participant M as Memory
    participant AI as OpenAI

    U->>F: è¾“å…¥æ¶ˆæ¯
    F->>F: éªŒè¯è¾“å…¥
    F->>F: æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    F->>F: è®¾ç½® loading çŠ¶æ€
    F->>A: POST /api/chat
    A->>A: æ„å›¾åˆ†ç±»
    A->>A: æ„å»ºä¸Šä¸‹æ–‡
    A->>AI: è°ƒç”¨ GPT-4o-mini
    AI-->>A: è¿”å› JSON å“åº”
    A->>A: è§£æå¹¶è¿‡æ»¤
    A->>M: å¼‚æ­¥ä¿å­˜æ¶ˆæ¯
    A-->>F: ChatResponse
    F->>F: æ˜¾ç¤º AI å›å¤
    F->>F: æ˜¾ç¤ºå»ºè®®è¡ŒåŠ¨
    F->>U: æ›´æ–°ç•Œé¢
```

### åœºæ™¯ 2: æƒ…ç»ªç­¹ç å¿«æ·å…¥å£

```mermaid
flowchart LR
    Chip1[ğŸ˜° æˆ‘æ…Œäº†] --> Chat1["AI: æˆ‘éš”ç€å±å¹•éƒ½æ„Ÿåˆ°äº†ä½ çš„ç„¦æ€¥..."]
    Chip2[ğŸ¤‘ æ€•è¸ç©º] --> Chat2["AI: é‚£ç§çœ¼çççœ‹ç€åˆ«äººèµšé’±çš„æ„Ÿè§‰ï¼Œæˆ‘æ‡‚..."]
    Chip3[ğŸ˜¡ æ°”æ­»äº†] --> Chat3["AI: è¿™ç§æ„¤æ€’æ˜¯æ­£å¸¸çš„ï¼Œè®©æˆ‘é™ªä½ ..."]
    Chip4[ğŸ˜Œ æƒ³å¤ç›˜] --> Chat4["AI: å¾ˆé«˜å…´ä½ æƒ³å¤ç›˜ï¼Œè¿™æ˜¯æˆé•¿çš„å¼€å§‹..."]
```

### åœºæ™¯ 3: ç½‘ç»œå¼‚å¸¸å¤„ç†

```mermaid
flowchart TB
    Error[API è¯·æ±‚å¤±è´¥] --> ShowToast[æ˜¾ç¤ºé”™è¯¯ Toast]
    ShowToast --> Options{ç”¨æˆ·é€‰æ‹©}
    Options -->|é‡è¯•| Retry[é‡æ–°å‘é€è¯·æ±‚]
    Options -->|å–æ¶ˆ| Revert[æ¢å¤è¾“å…¥æ¡†çŠ¶æ€]
    Retry --> CheckNetwork{ç½‘ç»œæ¢å¤?}
    CheckNetwork -->|æ˜¯| Success[æ­£å¸¸å“åº”]
    CheckNetwork -->|å¦| OfflineMode[è¿›å…¥ç¦»çº¿æ¨¡å¼]
    OfflineMode --> QueueMsg[æ¶ˆæ¯å…¥é˜Ÿ<br/>ç½‘ç»œæ¢å¤åå‘é€]
```

---

## UI çŠ¶æ€è¯´æ˜

### å¯¹è¯é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è¿”å›    AI æƒ…ç»ªæ•™ç»ƒ    ğŸ“ è®°å½•    â”‚  Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ¤– Coach                      â”‚ â”‚
â”‚  â”‚ æˆ‘èƒ½æ„Ÿå—åˆ°ä½ ç°åœ¨çš„ç„¦è™‘ã€‚      â”‚ â”‚
â”‚  â”‚ å…ˆæ·±å‘¼å¸å‡ æ¬¡...               â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚ â”‚
â”‚  â”‚ ğŸ’¡ å»ºè®®: æŠŠå½“å‰æƒ³æ³•å†™ä¸‹æ¥     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      ğŸ‘¤ ç”¨æˆ·  â”‚ â”‚
â”‚  â”‚ æˆ‘çš„èŒ…å°ä»Šå¤©è·Œäº†5%ï¼Œå¥½ç„¦è™‘    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ¤– Coach         [æƒ…ç»ª: ğŸ˜°]   â”‚ â”‚
â”‚  â”‚ æˆ‘éš”ç€å±å¹•éƒ½æ„Ÿå—åˆ°äº†...       â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚ â”‚
â”‚  â”‚ ğŸ’¡ æ·±å‘¼å¸ | è®°å½•æƒ³æ³• | æš‚ç¦»   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [è¾“å…¥ä½ çš„æƒ³æ³•...]         [å‘é€ â¤] â”‚  Input
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€å˜åŒ–

| çŠ¶æ€ | è¾“å…¥æ¡† | å‘é€æŒ‰é’® | æ¶ˆæ¯åŒºåŸŸ |
|------|--------|---------|---------|
| ç©ºé—² | å¯ç¼–è¾‘ | ç¦ç”¨ï¼ˆç°è‰²ï¼‰ | æ˜¾ç¤ºå†å² |
| è¾“å…¥ä¸­ | å¯ç¼–è¾‘ | å¯ç”¨ï¼ˆä¸»è‰²ï¼‰ | æ˜¾ç¤ºå†å² |
| å‘é€ä¸­ | ç¦ç”¨ | æ˜¾ç¤º loading | æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ + éª¨æ¶å± |
| å“åº”ä¸­ | ç¦ç”¨ | æ˜¾ç¤º loading | é€å­—æ˜¾ç¤º AI å›å¤ |
| å®Œæˆ | å¯ç¼–è¾‘ | ç¦ç”¨ | æ˜¾ç¤ºå®Œæ•´å¯¹è¯ |
| é”™è¯¯ | å¯ç¼–è¾‘ | æ˜¾ç¤ºé‡è¯• | æ˜¾ç¤ºé”™è¯¯æç¤º |

---

## è¾¹ç•Œæ¡ä»¶å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| ç”¨æˆ·æœªåˆå§‹åŒ– | è·³è½¬åˆ° Onboarding æµç¨‹ |
| è¾“å…¥ä¸ºç©º | ç¦ç”¨å‘é€æŒ‰é’®ï¼Œç‚¹å‡»æ—¶æç¤º |
| è¾“å…¥è¶…è¿‡ 500 å­— | æç¤º"æ¶ˆæ¯è¿‡é•¿"ï¼Œæˆªæ–­æˆ–æ‹’ç» |
| API è¶…æ—¶ (>10s) | æ˜¾ç¤ºè¶…æ—¶æç¤ºï¼Œå…è®¸é‡è¯• |
| ç½‘ç»œæ–­å¼€ | æ¶ˆæ¯å…¥é˜Ÿï¼Œç½‘ç»œæ¢å¤åè‡ªåŠ¨å‘é€ |
| AI è¿”å›æ— æ•ˆ JSON | ä½¿ç”¨é»˜è®¤å›å¤ï¼Œè®°å½•é”™è¯¯æ—¥å¿— |
| è¿ç»­ 5 è½®è´Ÿé¢æƒ…ç»ª | è§¦å‘æƒ…ç»ªç†”æ–­ï¼ˆP2 åŠŸèƒ½ï¼‰ |

---

## åŸ‹ç‚¹äº‹ä»¶

| äº‹ä»¶ | è§¦å‘æ—¶æœº | å±æ€§ |
|------|---------|------|
| `page_view` | è¿›å…¥å¯¹è¯é¡µ | `{ page: 'chat' }` |
| `chat_message_sent` | ç”¨æˆ·å‘é€æ¶ˆæ¯ | `{ message_length, session_id }` |
| `chat_response_received` | AI å“åº”è¿”å› | `{ emotion, intent, latency_ms }` |
| `chat_error` | API è¯·æ±‚å¤±è´¥ | `{ error_type, error_message }` |
| `chat_review_triggered` | ç‚¹å‡»å¤ç›˜æŒ‰é’® | `{ session_id, message_count }` |

---

## éªŒæ”¶æ ‡å‡†æ˜ å°„

| AC ID | æµç¨‹èŠ‚ç‚¹ | éªŒè¯æ–¹å¼ |
|-------|---------|---------|
| AC-002.1 | Start | é¦–é¡µæœ‰æ˜æ˜¾å…¥å£ |
| AC-002.2 | DisplayReply | æµå¼æ˜¾ç¤ºï¼ˆP1ï¼‰ |
| AC-002.3 | ParseResponse | å“åº”åŒ…å« emotion å­—æ®µ |
| AC-002.4 | DisplayReply | æ— æ“ä½œå»ºè®®è¯ |
| AC-002.5 | SaveLocal | æ•°æ®å†™å…¥ Supabase |
| AC-002.6 | LoadHistory | åŠ è½½ 15 å¤©å†…è®°å½• |
| AC-002.7 | WaitInput | æ— è½®æ•°é™åˆ¶ |

---

**æœ€åæ›´æ–°**: 2026-01-21
**å‚è€ƒæ–‡æ¡£**: [Functional Requirements FR-002](../../specs/requirements/functional-requirements.md#fr-002)
