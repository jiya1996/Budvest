# ä¼´æŠ• (Budvest) - ç”¨æˆ·å…¨æµç¨‹è¯¦è§£æ–‡æ¡£

## æ–‡æ¡£å…ƒæ•°æ®

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **ç‰ˆæœ¬** | V1.0 |
| **æ—¥æœŸ** | 2026å¹´1æœˆ18æ—¥ |
| **å…³è”PRD** | ä¼´æŠ•-äº§å“éœ€æ±‚æ–‡æ¡£-V1.1-å¿ƒç†ä¼˜å…ˆ.md |
| **çŠ¶æ€** | âœ… å·²å®šç¨¿ |

---

## ç›®å½•

1. [å…¨æµç¨‹æ¦‚è§ˆ](#1-å…¨æµç¨‹æ¦‚è§ˆ)
2. [åœºæ™¯A: ç”¨æˆ·ç™»å½•/æ³¨å†Œæµç¨‹](#2-åœºæ™¯a-ç”¨æˆ·ç™»å½•æ³¨å†Œæµç¨‹)
3. [åœºæ™¯B: ç”¨æˆ·è¾“å…¥æµç¨‹](#3-åœºæ™¯b-ç”¨æˆ·è¾“å…¥æµç¨‹)
4. [åœºæ™¯C: AIå¯¹è¯æµç¨‹](#4-åœºæ™¯c-aiå¯¹è¯æµç¨‹)
5. [åœºæ™¯D: å¤ç›˜è®°å½•æµç¨‹](#5-åœºæ™¯d-å¤ç›˜è®°å½•æµç¨‹)
6. [åœºæ™¯E: å¼‚å¸¸å¤„ç†æµç¨‹](#6-åœºæ™¯e-å¼‚å¸¸å¤„ç†æµç¨‹)
7. [åœºæ™¯F: æ¸¸å®¢è½¬åŒ–æµç¨‹](#7-åœºæ™¯f-æ¸¸å®¢è½¬åŒ–æµç¨‹)
8. [çŠ¶æ€æœºå®šä¹‰](#8-çŠ¶æ€æœºå®šä¹‰)

---

## 1. å…¨æµç¨‹æ¦‚è§ˆ

### 1.1 ç”¨æˆ·æ—…ç¨‹åœ°å›¾

```mermaid
journey
    title Budvest ç”¨æˆ·å®Œæ•´æ—…ç¨‹
    section æé€Ÿå¯åŠ¨
      æ‰“å¼€App: 5: ç”¨æˆ·
      çœ‹åˆ°é—ªå±: 4: ç”¨æˆ·
      è®¾ç½®æŠ•èµ„åˆå¿ƒ: 4: ç”¨æˆ·
      æ·»åŠ å¿ƒç†é”šç‚¹: 4: ç”¨æˆ·
    section æ—¥å¸¸ä½¿ç”¨
      æŸ¥çœ‹æ¸©åº¦é¦–é¡µ: 5: ç”¨æˆ·
      ç‚¹å‡»æƒ…ç»ªç­¹ç : 4: ç”¨æˆ·
      ä¸AIå¯¹è¯: 5: ç”¨æˆ·
      è·å¾—å…±æƒ…: 5: ç”¨æˆ·
    section ç†æ€§å›å½’
      è§¦å‘ç†”æ–­: 2: ç”¨æˆ·
      æ·±å‘¼å¸å†·é™: 3: ç”¨æˆ·
      å†™ä¸‹ç†ç”±: 4: ç”¨æˆ·
    section å¤ç›˜æˆé•¿
      è®°å½•å¿ƒæƒ…å˜åŒ–: 4: ç”¨æˆ·
      é€‰æ‹©å†³ç­–: 4: ç”¨æˆ·
      è·å¾—å¾½ç« : 5: ç”¨æˆ·
      ç»‘å®šè´¦å·: 4: ç”¨æˆ·
```

### 1.2 å››é˜¶æ®µçŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> Phase1_Onboarding: é¦–æ¬¡æ‰“å¼€
    Phase1_Onboarding --> Phase2_Dashboard: å®Œæˆåˆå¿ƒè®¾å®š
    Phase2_Dashboard --> Phase3_Chat: ç‚¹å‡»FAB/èµ„äº§å¡ç‰‡
    Phase3_Chat --> Phase3_Chat: æŒç»­å¯¹è¯
    Phase3_Chat --> Phase3_CircuitBreaker: æƒ…ç»ªå¤±æ§(5è½®)
    Phase3_CircuitBreaker --> Phase3_Chat: å†·é™åç»§ç»­
    Phase3_Chat --> Phase4_Closure: ç‚¹å‡»è®°å½•
    Phase4_Closure --> Phase2_Dashboard: å®Œæˆå¤ç›˜
    Phase2_Dashboard --> [*]: é€€å‡ºApp

    note right of Phase1_Onboarding: 15ç§’å†…å®Œæˆ
    note right of Phase3_CircuitBreaker: å¼ºåˆ¶30ç§’å†·é™
```

---

## 2. åœºæ™¯A: ç”¨æˆ·ç™»å½•/æ³¨å†Œæµç¨‹

### 2.1 æ¸¸å®¢æ¨¡å¼å¯åŠ¨æµç¨‹

**è®¾è®¡åŸåˆ™**: é›¶é—¨æ§›ä½“éªŒï¼Œ15ç§’å†…ä»é™Œç”Ÿäººå˜ä¸ºå¥‘çº¦ä¼™ä¼´

```mermaid
flowchart TD
    subgraph å…¥å£åˆ¤æ–­
        A[ç”¨æˆ·æ‰“å¼€App] --> B{æ£€æŸ¥localStorage}
        B -->|æœ‰device_id| C[ç›´æ¥è¿›å…¥é¦–é¡µ]
        B -->|æ— device_id| D[å±•ç¤ºæƒ…æ„Ÿé—ªå±]
    end

    subgraph æ¸¸å®¢åˆå§‹åŒ–
        D --> E[2-3ç§’åè‡ªåŠ¨è·³è½¬]
        E --> F[åˆå¿ƒè®¾å®šé¡µ]
        F --> G{ç”¨æˆ·é€‰æ‹©ç›®æ ‡}
        G -->|é€‰æ‹©å®Œæˆ| H[ç”ŸæˆGuest UUID]
        H --> I[å­˜å‚¨åˆ°localStorage]
        I --> J[å†™å…¥DB profiles]
    end

    subgraph å¿ƒç†é”šç‚¹
        J --> K[å¿ƒç†é”šç‚¹é¡µ]
        K --> L{æ·»åŠ èµ„äº§}
        L -->|æ·»åŠ 1-3ä¸ª| M[å­˜å…¥DB watchlists]
        L -->|è·³è¿‡| N[ç©ºåˆ—è¡¨]
        M --> O[è¿›å…¥é¦–é¡µ]
        N --> O
    end

    C --> O

    style D fill:#fff5f5
    style H fill:#f5fff5
    style O fill:#f5f5ff
```

### 2.2 æ­¥éª¤è¯¦è§£è¡¨

| æ­¥éª¤ID | ç•Œé¢ | ç”¨æˆ·æ“ä½œ | ç³»ç»Ÿé€»è¾‘ | æ•°æ®å˜æ›´ |
|--------|------|---------|---------|---------|
| A-01 | é—ªå± | æ—  (è§‚çœ‹) | æ£€æŸ¥ `localStorage.device_id` | æ—  |
| A-02 | é—ªå± | æ—  (ç­‰å¾…) | è®¡æ—¶ 2-3 ç§’ | æ—  |
| A-03 | åˆå¿ƒè®¾å®š | å¤šé€‰ç›®æ ‡ | éªŒè¯è‡³å°‘é€‰ 1 é¡¹ | æš‚å­˜å†…å­˜ |
| A-04 | åˆå¿ƒè®¾å®š | ç‚¹å‡»"ä¸‹ä¸€æ­¥" | ç”Ÿæˆ UUIDï¼Œè°ƒç”¨ API | `profiles.insert()` |
| A-05 | å¿ƒç†é”šç‚¹ | è¾“å…¥ä»£ç  | æœç´¢å»ºè®®ï¼ŒéªŒè¯ä»£ç  | æš‚å­˜å†…å­˜ |
| A-06 | å¿ƒç†é”šç‚¹ | ç‚¹å‡»"å®Œæˆ" | æ‰¹é‡å†™å…¥ | `watchlists.insert()` |

### 2.3 API è°ƒç”¨åºåˆ—

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯
    participant LS as localStorage
    participant API as /api/onboarding
    participant DB as Supabase

    U->>FE: æ‰“å¼€App
    FE->>LS: æ£€æŸ¥ device_id
    alt å·²æœ‰device_id
        LS-->>FE: è¿”å› device_id
        FE->>FE: è·³è½¬é¦–é¡µ
    else æ— device_id
        FE->>U: å±•ç¤ºé—ªå±
        Note over FE: ç­‰å¾…2-3ç§’
        FE->>U: å±•ç¤ºåˆå¿ƒè®¾å®š
        U->>FE: é€‰æ‹©ç›®æ ‡ + ç‚¹å‡»ä¸‹ä¸€æ­¥
        FE->>API: POST /init {goals: [...]}
        API->>DB: INSERT profiles
        DB-->>API: è¿”å› user_id
        API-->>FE: {device_id, user_id}
        FE->>LS: å­˜å‚¨ device_id
        FE->>U: å±•ç¤ºå¿ƒç†é”šç‚¹
        U->>FE: æ·»åŠ èµ„äº§ + ç‚¹å‡»å®Œæˆ
        FE->>API: POST /watchlist {symbols: [...]}
        API->>DB: INSERT watchlists
        FE->>U: è¿›å…¥é¦–é¡µ
    end
```

### 2.4 è¾¹ç•Œæ¡ä»¶å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| ç½‘ç»œæ–­å¼€æ—¶å®Œæˆåˆå¿ƒè®¾å®š | æœ¬åœ°æš‚å­˜ï¼Œæ¢å¤ååŒæ­¥ |
| è¾“å…¥æ— æ•ˆè‚¡ç¥¨ä»£ç  | æç¤º"æœªæ‰¾åˆ°è¯¥èµ„äº§" |
| æ·»åŠ è¶…è¿‡3ä¸ªèµ„äº§ | ç¦ç”¨æ·»åŠ æŒ‰é’®ï¼Œæç¤º"æœ€å¤š3ä¸ª" |
| ä¸­é€”é€€å‡ºApp | ä¸‹æ¬¡æ‰“å¼€ä»é—ªå±é‡æ–°å¼€å§‹ |
| æ¸…é™¤æµè§ˆå™¨æ•°æ® | è§†ä¸ºæ–°ç”¨æˆ·ï¼Œé‡æ–°åˆå§‹åŒ– |

---

## 3. åœºæ™¯B: ç”¨æˆ·è¾“å…¥æµç¨‹

### 3.1 æŠ•èµ„åˆå¿ƒè¾“å…¥æµç¨‹

```mermaid
flowchart TD
    subgraph åˆå¿ƒè®¾å®š
        A[å±•ç¤ºé—®å€™è¯­] --> B[æ˜¾ç¤ºé€‰é¡¹åˆ—è¡¨]
        B --> C{ç”¨æˆ·é€‰æ‹©}
        C -->|é€‰æ‹©é¢„è®¾| D[é€‰é¡¹é«˜äº®]
        C -->|é€‰æ‹©å…¶ä»–| E[å±•å¼€è¾“å…¥æ¡†]
        D --> F{ç»§ç»­é€‰æ‹©?}
        E --> G[ç”¨æˆ·è¾“å…¥è‡ªå®šä¹‰]
        G --> F
        F -->|æ˜¯| C
        F -->|å¦| H{éªŒè¯é€‰æ‹©}
        H -->|è‡³å°‘1é¡¹| I[å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®]
        H -->|0é¡¹| J[ç¦ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®]
    end

    style A fill:#fff5f5
    style I fill:#f5fff5
```

### 3.2 æŠ•èµ„ç›®æ ‡é€‰é¡¹è®¾è®¡

| é€‰é¡¹ID | æ˜¾ç¤ºæ–‡æœ¬ | å­˜å‚¨å€¼ | å›¾æ ‡ | è¯´æ˜ |
|--------|---------|-------|------|------|
| G01 | åšæ—¶é—´çš„æœ‹å‹ | `long_term` | ğŸŒ± | é•¿çº¿æŠ•èµ„è€… |
| G02 | æ•æ‰å¸‚åœºæœºä¼š | `short_term` | âš¡ï¸ | çŸ­çº¿äº¤æ˜“è€… |
| G03 | å…¶ä»– | `custom:{text}` | âœï¸ | è‡ªå®šä¹‰è¾“å…¥ |

### 3.3 å¿ƒç†é”šç‚¹è¾“å…¥æµç¨‹

```mermaid
flowchart TD
    subgraph èµ„äº§æœç´¢
        A[ç”¨æˆ·è¾“å…¥ä»£ç ] --> B{è¾“å…¥é•¿åº¦}
        B -->|>=2å­—ç¬¦| C[è§¦å‘æœç´¢]
        B -->|<2å­—ç¬¦| D[ä¸è§¦å‘]
        C --> E[è°ƒç”¨æœç´¢API]
        E --> F{è¿”å›ç»“æœ}
        F -->|æœ‰ç»“æœ| G[å±•ç¤ºå»ºè®®åˆ—è¡¨]
        F -->|æ— ç»“æœ| H[æç¤ºæœªæ‰¾åˆ°]
    end

    subgraph æ·»åŠ èµ„äº§
        G --> I[ç”¨æˆ·ç‚¹å‡»å»ºè®®é¡¹]
        I --> J{å½“å‰æ•°é‡}
        J -->|<3| K[æ·»åŠ åˆ°åˆ—è¡¨]
        J -->|=3| L[æç¤ºå·²æ»¡]
        K --> M[æ›´æ–°UIåˆ—è¡¨]
        M --> N{ç»§ç»­æ·»åŠ ?}
        N -->|æ˜¯| A
        N -->|å¦| O[ç‚¹å‡»å®Œæˆ]
    end

    subgraph åˆ é™¤èµ„äº§
        M --> P[ç”¨æˆ·ç‚¹å‡»åˆ é™¤]
        P --> Q[ä»åˆ—è¡¨ç§»é™¤]
        Q --> M
    end

    style K fill:#f5fff5
    style L fill:#fff5f5
```

### 3.4 è‚¡ç¥¨ä»£ç è¯†åˆ«è§„åˆ™

| å¸‚åœº | ä»£ç æ ¼å¼ | ç¤ºä¾‹ | è¯†åˆ«è§„åˆ™ |
|------|---------|------|---------|
| Aè‚¡-æ²ªå¸‚ | 6ä½æ•°å­—ï¼Œ6å¼€å¤´ | 600519 | `/^6\d{5}$/` |
| Aè‚¡-æ·±å¸‚ | 6ä½æ•°å­—ï¼Œ0/3å¼€å¤´ | 000001, 300750 | `/^[03]\d{5}$/` |
| Aè‚¡-åŒ—äº¤æ‰€ | 6ä½æ•°å­—ï¼Œ8å¼€å¤´ | 830799 | `/^8\d{5}$/` |
| ç¾è‚¡ | 1-5ä½å­—æ¯ | NVDA, AAPL | `/^[A-Z]{1,5}$/` |
| æ¸¯è‚¡ | 5ä½æ•°å­— | 00700 | `/^\d{5}$/` |

### 3.5 æœç´¢å»ºè®®UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” è¾“å…¥ä»£ç æˆ–åç§°...           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ NVDA                     â”‚  â”‚
â”‚  â”‚ è‹±ä¼Ÿè¾¾ Â· NASDAQ Â· $890   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 600519                   â”‚  â”‚
â”‚  â”‚ è´µå·èŒ…å° Â· æ²ªA Â· Â¥1650   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. åœºæ™¯C: AIå¯¹è¯æµç¨‹

### 4.1 å¯¹è¯è§¦å‘å…¥å£

```mermaid
flowchart TD
    subgraph é¦–é¡µå…¥å£
        A[æ¸©åº¦é¦–é¡µ] --> B{ç”¨æˆ·æ“ä½œ}
        B -->|ç‚¹å‡»FAB| C[é€šç”¨å¯¹è¯å…¥å£]
        B -->|ç‚¹å‡»èµ„äº§å¡ç‰‡| D[èµ„äº§ä¸Šä¸‹æ–‡å¯¹è¯]
    end

    subgraph ä¸Šä¸‹æ–‡å‡†å¤‡
        C --> E[ç©ºä¸Šä¸‹æ–‡]
        D --> F[æºå¸¦èµ„äº§ä¿¡æ¯]
        E --> G[åˆå§‹åŒ–å¯¹è¯]
        F --> G
    end

    subgraph ä¸Šä¸‹æ–‡å†…å®¹
        G --> H[ç»„è£…Context]
        H --> I["symbol: NVDA"]
        H --> J["change: -2.3%"]
        H --> K["user_goals: [long_term]"]
        H --> L["mood_history: [anxious]"]
    end
```

### 4.2 æƒ…ç»ªç­¹ç å¯¹è¯æµç¨‹

```mermaid
flowchart TD
    subgraph ç­¹ç ç‚¹å‡»
        A[ç”¨æˆ·ç‚¹å‡»æƒ…ç»ªç­¹ç ] --> B{ç­¹ç ç±»å‹}
        B -->|ğŸ˜°æˆ‘æ…Œäº†| C1[anxious]
        B -->|ğŸ¤‘æ€•è¸ç©º| C2[greedy]
        B -->|ğŸ˜¡æ°”æ­»äº†| C3[angry]
        B -->|ğŸ˜Œæƒ³å¤ç›˜| C4[calm]
    end

    subgraph é•œåƒå…±æƒ…
        C1 --> D1["æˆ‘éš”ç€å±å¹•éƒ½æ„Ÿåˆ°äº†ä½ çš„ç„¦æ€¥..."]
        C2 --> D2["é‚£ç§çœ¼çççœ‹ç€åˆ«äººèµšé’±çš„æ„Ÿè§‰ï¼Œæˆ‘æ‡‚..."]
        C3 --> D3["è¿™ç§æ„¤æ€’æ˜¯æ­£å¸¸çš„ï¼Œè®©æˆ‘é™ªä½ ..."]
        C4 --> D4["å¾ˆé«˜å…´ä½ æƒ³å¤ç›˜ï¼Œè¿™æ˜¯æˆé•¿çš„å¼€å§‹..."]
    end

    subgraph ç­–ç•¥æ£€æŸ¥
        D1 --> E{æ£€æŸ¥ç”¨æˆ·goals}
        D2 --> E
        D3 --> E
        D4 --> F[ç›´æ¥å¼•å¯¼å¤ç›˜]
        E -->|ä»…long_term| G[ä¿¡ä»°æ¨¡å¼]
        E -->|ä»…short_term| H[çºªå¾‹æ¨¡å¼]
        E -->|æ··åˆç­–ç•¥| I[ç­–ç•¥è¿½é—®]
    end

    style A fill:#fff5f5
    style D1 fill:#e1f5ff
    style D2 fill:#e1f5ff
    style D3 fill:#e1f5ff
    style D4 fill:#d4edda
```

### 4.3 ç­–ç•¥è¿½é—®ä¸é”å®šæµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant AI as AIåŠ©æ‰‹
    participant DB as æ•°æ®åº“

    U->>AI: [ç‚¹å‡» ğŸ˜°æˆ‘æ…Œäº†]
    AI->>DB: æŸ¥è¯¢ user.investment_goals
    DB-->>AI: ['long_term', 'short_term']

    Note over AI: æ£€æµ‹åˆ°æ··åˆç­–ç•¥

    AI->>U: "æˆ‘éš”ç€å±å¹•éƒ½æ„Ÿåˆ°äº†ä½ çš„ç„¦æ€¥..."
    AI->>U: "NVDA æ˜¯ä½ çš„é•¿çº¿ä»“è¿˜æ˜¯çŸ­çº¿ä»“ï¼Ÿ"

    alt ç”¨æˆ·å›ç­”çŸ­çº¿
        U->>AI: "æ˜¯çŸ­çº¿"
        AI->>AI: é”å®šçºªå¾‹æ¨¡å¼
        AI->>U: "æ—¢ç„¶æ˜¯çŸ­çº¿ï¼Œè·Œç ´æ­¢æŸçº¿äº†å—ï¼Ÿ"

        loop çºªå¾‹æ¨¡å¼å¯¹è¯
            U->>AI: å›ç­”é—®é¢˜
            AI->>U: ç»§ç»­çºªå¾‹å¼•å¯¼
        end
    else ç”¨æˆ·å›ç­”é•¿çº¿
        U->>AI: "æ˜¯é•¿çº¿"
        AI->>AI: é”å®šä¿¡ä»°æ¨¡å¼
        AI->>U: "æ—¢ç„¶æ˜¯é•¿çº¿ï¼ŒåŸºæœ¬é¢å˜äº†å—ï¼Ÿ"

        loop ä¿¡ä»°æ¨¡å¼å¯¹è¯
            U->>AI: å›ç­”é—®é¢˜
            AI->>U: ç»§ç»­ä¿¡ä»°å¼•å¯¼
        end
    end
```

### 4.4 å¯¹è¯æ¨¡å¼è¯¦è§£

#### 4.4.1 çºªå¾‹æ¨¡å¼ (çŸ­çº¿)

| é˜¶æ®µ | AIæé—® | ç›®çš„ |
|------|-------|------|
| 1. æ­¢æŸæ£€æŸ¥ | "è·Œç ´æ­¢æŸçº¿äº†å—ï¼Ÿæ­¢æŸçº¿è®¾åœ¨å“ªé‡Œï¼Ÿ" | ç¡®è®¤æ˜¯å¦è§¦å‘æ­¢æŸ |
| 2. æ­¢ç›ˆæ£€æŸ¥ | "è·ç¦»æ­¢ç›ˆç›®æ ‡è¿˜æœ‰å¤šè¿œï¼Ÿ" | ç¡®è®¤ç›ˆåˆ©ç©ºé—´ |
| 3. çºªå¾‹æé†’ | "ä½ å½“åˆä¹°å…¥çš„ç†ç”±è¿˜æˆç«‹å—ï¼Ÿ" | å›é¡¾äº¤æ˜“é€»è¾‘ |
| 4. è¡ŒåŠ¨å¼•å¯¼ | "å¦‚æœè§¦å‘æ­¢æŸï¼Œä½ æ‰“ç®—æ€ä¹ˆåšï¼Ÿ" | å¼•å¯¼ç†æ€§å†³ç­– |

#### 4.4.2 ä¿¡ä»°æ¨¡å¼ (é•¿çº¿)

| é˜¶æ®µ | AIæé—® | ç›®çš„ |
|------|-------|------|
| 1. åŸºæœ¬é¢æ£€æŸ¥ | "å…¬å¸çš„åŸºæœ¬é¢å˜äº†å—ï¼Ÿ" | èšç„¦ä»·å€¼è€Œéä»·æ ¼ |
| 2. åˆå¿ƒå›é¡¾ | "å½“åˆä¹°å…¥çš„ç†ç”±æ˜¯ä»€ä¹ˆï¼Ÿ" | å›é¡¾æŠ•èµ„é€»è¾‘ |
| 3. æƒ…ç»ªåˆ†ç¦» | "å¸‚åœºæ³¢åŠ¨â‰ å…¬å¸ä»·å€¼å˜åŒ–" | åˆ†ç¦»æƒ…ç»ªå’Œäº‹å® |
| 4. é•¿æœŸè§†è§’ | "3å¹´åå›çœ‹ä»Šå¤©ï¼Œè¿™ä¸ªä»·æ ¼é‡è¦å—ï¼Ÿ" | å»ºç«‹é•¿æœŸè§†è§’ |

### 4.5 ç†”æ–­æœºåˆ¶æµç¨‹

```mermaid
flowchart TD
    subgraph æƒ…ç»ªç›‘æµ‹
        A[ç”¨æˆ·å‘é€æ¶ˆæ¯] --> B[æƒ…ç»ªåˆ†æ]
        B --> C{æ£€æµ‹è´Ÿé¢æƒ…ç»ª}
        C -->|å¦| D[æ­£å¸¸å“åº”]
        C -->|æ˜¯| E[ç´¯è®¡è®¡æ•°+1]
        E --> F{è¿ç»­>=5è½®?}
        F -->|å¦| D
        F -->|æ˜¯| G[è§¦å‘ç†”æ–­]
    end

    subgraph ç†”æ–­æ‰§è¡Œ
        G --> H[AIå‘é€æš‚åœæ¶ˆæ¯]
        H --> I[éšè—è¾“å…¥æ¡†]
        I --> J[å±•ç¤ºæ·±å‘¼å¸åŠ¨ç”»]
        J --> K[30ç§’å€’è®¡æ—¶]
        K --> L[å±•ç¤ºç†ç”±è¾“å…¥æ¡†]
        L --> M{ç”¨æˆ·è¾“å…¥ç†ç”±}
        M -->|æäº¤| N[è®°å½•ç†”æ–­æ—¥å¿—]
        M -->|è·³è¿‡| O[è®°å½•è·³è¿‡]
        N --> P[æ¢å¤å¯¹è¯]
        O --> P
    end

    style G fill:#fff5f5
    style J fill:#e1f5ff
    style P fill:#d4edda
```

### 4.6 ç†”æ–­è§¦å‘è¯åº“

| ç±»åˆ« | å…³é”®è¯ | æƒé‡ |
|------|-------|------|
| ææ…Œç±» | å´©ã€å®Œäº†ã€å…¨æ²¡äº†ã€è¡€äºã€è·³æ¥¼ | 2 |
| å†²åŠ¨ç±» | å…¨å–ã€æ¸…ä»“ã€å‰²è‚‰ã€è·‘ã€æ’¤ | 1.5 |
| æ„¤æ€’ç±» | æ“ã€å¦ˆçš„ã€åƒåœ¾ã€éª—å­ | 2 |
| ç»æœ›ç±» | ä¸ç©äº†ã€å†ä¹Ÿä¸ã€è®¤å‘½ | 1.5 |

**ç†”æ–­å…¬å¼**: `æ€»åˆ† = Î£(è¯æƒé‡)`, å½“ `æ€»åˆ† >= 5` æˆ– `è¿ç»­5è½®è´Ÿé¢` æ—¶è§¦å‘

### 4.7 æ·±å‘¼å¸åŠ¨ç”»UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚                                â”‚
â”‚         â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®           â”‚
â”‚        â•±            â•²          â”‚
â”‚       â”‚    å¸æ°”...   â”‚         â”‚
â”‚        â•²            â•±          â”‚
â”‚         â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯           â”‚
â”‚                                â”‚
â”‚           â—‹â—‹â—‹â—‹â—â—‹â—‹â—‹â—‹            â”‚
â”‚             27ç§’               â”‚
â”‚                                â”‚
â”‚      é—­ä¸Šçœ¼ç›ï¼Œæ„Ÿå—å‘¼å¸         â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ¨ç”»çŠ¶æ€:
- 0-4ç§’: åœ†åœˆæ”¾å¤§ + "å¸æ°”..."
- 4-7ç§’: åœ†åœˆä¿æŒ + "å±ä½..."
- 7-11ç§’: åœ†åœˆç¼©å° + "å‘¼æ°”..."
- å¾ªç¯ç›´åˆ°30ç§’ç»“æŸ
```

---

## 5. åœºæ™¯D: å¤ç›˜è®°å½•æµç¨‹

### 5.1 å¤ç›˜å…¥å£ä¸è§¦å‘

```mermaid
flowchart TD
    subgraph è§¦å‘æ—¶æœº
        A[å¯¹è¯é¡µé¡¶éƒ¨] --> B["âœ… è®°å½•" æŒ‰é’®]
        C[å¯¹è¯ç»“æŸæç¤º] --> D["è¦è®°å½•ä¸€ä¸‹å—ï¼Ÿ"]
        E[ç†”æ–­å†·é™å] --> F[è‡ªåŠ¨å¼¹å‡ºå¤ç›˜]
    end

    subgraph ç»Ÿä¸€å…¥å£
        B --> G[æ‰“å¼€å¤ç›˜Modal]
        D --> G
        F --> G
    end

    subgraph å¤ç›˜å†…å®¹
        G --> H[Step1: å¿ƒæƒ…æ»‘åŠ¨]
        H --> I[Step2: å†³ç­–é€‰æ‹©]
        I --> J[Step3: å¯é€‰å¤‡æ³¨]
        J --> K[æäº¤]
    end
```

### 5.2 å¤ç›˜å¡ç‰‡UIæµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as å¤ç›˜Modal
    participant API as /api/review
    participant DB as Supabase

    U->>UI: ç‚¹å‡»"è®°å½•"æŒ‰é’®
    UI->>UI: æ‰“å¼€Modal

    Note over UI: Step 1: å¿ƒæƒ…å˜åŒ–
    UI->>U: å±•ç¤ºå¿ƒæƒ…æ»‘åŠ¨æ¡ (ğŸ˜° â†’ ğŸ˜Œ)
    U->>UI: æ»‘åŠ¨é€‰æ‹©å¿ƒæƒ…å€¼ (1-5)

    Note over UI: Step 2: å†³ç­–é€‰æ‹©
    UI->>U: å±•ç¤ºå†³ç­–é€‰é¡¹
    U->>UI: é€‰æ‹© [ğŸ”’é”ä»“]

    Note over UI: Step 3: å¤‡æ³¨(å¯é€‰)
    UI->>U: å±•ç¤ºå¤‡æ³¨è¾“å…¥æ¡†
    U->>UI: è¾“å…¥ "å…ˆè§‚æœ›ä¸€ä¸‹"

    U->>UI: ç‚¹å‡»"æäº¤è®°å½•"
    UI->>API: POST /review
    API->>DB: INSERT review_logs
    DB-->>API: è¿”å› review_id
    API->>API: è®¡ç®—å¾½ç« 
    API-->>UI: {review_id, badge: "willpower"}

    UI->>UI: å…³é—­Modal
    UI->>U: æ’­æ”¾æ’’èŠ±åŠ¨ç”»
    UI->>U: æ˜¾ç¤ºå¾½ç« è·å¾—
```

### 5.3 å†³ç­–é€‰é¡¹è®¾è®¡

| é€‰é¡¹ID | æ˜¾ç¤º | å­˜å‚¨å€¼ | é¢œè‰² | è¯´æ˜ |
|--------|------|-------|------|------|
| D01 | ğŸ”’ é”ä»“ | `lock` | Teal | ä¸åšä»»ä½•æ“ä½œ |
| D02 | ğŸ“‰ å‡ä»“ | `reduce` | Yellow | éƒ¨åˆ†å–å‡º |
| D03 | ğŸ“ˆ åŠ ä»“ | `add` | Coral | ä¹°å…¥æ›´å¤š |
| D04 | ğŸš« æ¸…ä»“ | `clear` | Gray | å…¨éƒ¨å–å‡º |

### 5.4 å¿ƒæƒ…æ»‘åŠ¨æ¡è®¾è®¡

```
å¿ƒæƒ…å˜åŒ– (å¯¹è¯å‰ â†’ å¯¹è¯å):

     ğŸ˜°      ğŸ˜Ÿ      ğŸ˜      ğŸ™‚      ğŸ˜Œ
      1       2       3       4       5
      â”‚â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
            å½“å‰å€¼: 2

æ»‘åŠ¨æ¡æ ·å¼:
- è½¨é“: æ¸å˜è‰² (çº¢ â†’ ç»¿)
- æ»‘å—: åœ†å½¢ï¼Œå¸¦é˜´å½±
- è§¦æ„Ÿ: æ»‘åŠ¨æ—¶æœ‰éœ‡åŠ¨åé¦ˆ
```

### 5.5 å¤ç›˜æ•°æ®ç»“æ„

```typescript
interface ReviewLog {
  id: string;
  user_id: string;

  // å¿ƒæƒ…æ•°æ®
  mood_before: 1 | 2 | 3 | 4 | 5;  // å¯¹è¯å‰å¿ƒæƒ… (ä»å¯¹è¯å¼€å§‹æ—¶è®°å½•)
  mood_after: 1 | 2 | 3 | 4 | 5;   // å¯¹è¯åå¿ƒæƒ… (ç”¨æˆ·æ»‘åŠ¨é€‰æ‹©)
  mood_change: number;             // è®¡ç®—å€¼: after - before

  // å†³ç­–æ•°æ®
  decision: 'lock' | 'reduce' | 'add' | 'clear';
  related_symbol?: string;         // å…³è”çš„èµ„äº§ä»£ç 

  // ä¸Šä¸‹æ–‡
  note?: string;                   // ç”¨æˆ·å¤‡æ³¨ (æœ€é•¿100å­—)
  chat_session_id: string;         // å…³è”çš„å¯¹è¯ä¼šè¯
  circuit_breaker_triggered: boolean; // æ˜¯å¦è§¦å‘è¿‡ç†”æ–­

  // å¥–åŠ±
  badge_earned?: 'willpower' | 'calm' | 'persistence';

  created_at: Date;
}
```

---

## 6. åœºæ™¯E: å¼‚å¸¸å¤„ç†æµç¨‹

### 6.1 ç½‘ç»œå¼‚å¸¸å¤„ç†

```mermaid
flowchart TD
    subgraph ç½‘ç»œæ£€æµ‹
        A[ç”¨æˆ·æ“ä½œ] --> B{ç½‘ç»œçŠ¶æ€}
        B -->|åœ¨çº¿| C[æ­£å¸¸è¯·æ±‚]
        B -->|ç¦»çº¿| D[ç¦»çº¿å¤„ç†]
    end

    subgraph ç¦»çº¿å¤„ç†
        D --> E{æ“ä½œç±»å‹}
        E -->|è¯»å–| F[ä½¿ç”¨æœ¬åœ°ç¼“å­˜]
        E -->|å†™å…¥| G[æœ¬åœ°é˜Ÿåˆ—æš‚å­˜]
        F --> H[å±•ç¤ºç¼“å­˜æ•°æ®+ç¦»çº¿æ ‡è¯†]
        G --> I[æç¤º"ç¨ååŒæ­¥"]
    end

    subgraph æ¢å¤åŒæ­¥
        J[ç½‘ç»œæ¢å¤] --> K[æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—]
        K --> L{æœ‰å¾…åŒæ­¥æ•°æ®?}
        L -->|æ˜¯| M[åå°åŒæ­¥]
        L -->|å¦| N[æ­£å¸¸æ¨¡å¼]
        M --> O{åŒæ­¥æˆåŠŸ?}
        O -->|æ˜¯| P[æ¸…é™¤é˜Ÿåˆ—]
        O -->|å¦| Q[ä¿ç•™+æç¤º]
    end
```

### 6.2 API é”™è¯¯å¤„ç†

| é”™è¯¯ç  | åœºæ™¯ | ç”¨æˆ·æç¤º | å¤„ç†æ–¹å¼ |
|--------|------|---------|---------|
| 400 | å‚æ•°é”™è¯¯ | "è¾“å…¥æ ¼å¼æœ‰è¯¯" | é«˜äº®é”™è¯¯å­—æ®µ |
| 401 | æœªæˆæƒ | "è¯·é‡æ–°ç™»å½•" | è·³è½¬ç™»å½•é¡µ |
| 404 | èµ„æºä¸å­˜åœ¨ | "æ‰¾ä¸åˆ°è¯¥èµ„äº§" | è¿”å›æœç´¢é¡µ |
| 429 | è¯·æ±‚è¿‡é¢‘ | "ç¨ç­‰ç‰‡åˆ»å†è¯•" | ç¦ç”¨æŒ‰é’®60ç§’ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨å" | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |
| 503 | AI æœåŠ¡ä¸å¯ç”¨ | "AI æ­£åœ¨ä¼‘æ¯" | å±•ç¤ºé¢„è®¾å›å¤ |

### 6.3 AI å“åº”è¶…æ—¶å¤„ç†

```mermaid
flowchart TD
    A[å‘é€æ¶ˆæ¯] --> B[æ˜¾ç¤ºåŠ è½½çŠ¶æ€]
    B --> C{3ç§’å†…å“åº”?}
    C -->|æ˜¯| D[æ­£å¸¸å±•ç¤º]
    C -->|å¦| E[æ˜¾ç¤º"æ€è€ƒä¸­..."]
    E --> F{10ç§’å†…å“åº”?}
    F -->|æ˜¯| D
    F -->|å¦| G[æ˜¾ç¤ºè¶…æ—¶æç¤º]
    G --> H["AIå¼€å°å·®äº†ï¼Œå†è¯•ä¸€æ¬¡ï¼Ÿ"]
    H --> I{ç”¨æˆ·é€‰æ‹©}
    I -->|é‡è¯•| A
    I -->|å–æ¶ˆ| J[è¿”å›å¯¹è¯]
```

### 6.4 æ•°æ®å†²çªå¤„ç†

| åœºæ™¯ | å¤„ç†ç­–ç•¥ |
|------|---------|
| å¤šè®¾å¤‡åŒæ—¶ç¼–è¾‘ | ä»¥æœ€åæäº¤ä¸ºå‡† |
| æ¸¸å®¢ç»‘å®šå·²å­˜åœ¨æ‰‹æœºå· | æç¤º"è¯¥æ‰‹æœºå·å·²æ³¨å†Œ"ï¼Œå¼•å¯¼ç™»å½• |
| å¤ç›˜é‡å¤æäº¤ | å¹‚ç­‰å¤„ç†ï¼Œè¿”å›å·²å­˜åœ¨è®°å½• |

---

## 7. åœºæ™¯F: æ¸¸å®¢è½¬åŒ–æµç¨‹

### 7.1 è½¬åŒ–æ—¶æœºä¸è§¦å‘

```mermaid
flowchart TD
    subgraph è½¬åŒ–æ—¶æœº
        A[é¦–æ¬¡å¤ç›˜å®Œæˆ] --> E[å±•ç¤ºç»‘å®šBanner]
        B[ç´¯è®¡3æ¬¡å¯¹è¯] --> E
        C[è·å¾—å¾½ç« ] --> E
        D[è®¾ç½®é¡µç‚¹å‡»] --> F[ç›´æ¥è¿›å…¥ç»‘å®š]
    end

    subgraph è½¬åŒ–å¼•å¯¼
        E --> G{ç”¨æˆ·ç‚¹å‡»Banner}
        G -->|ç‚¹å‡»ç»‘å®š| F
        G -->|å…³é—­Banner| H[è®°å½•æ‹’ç»æ¬¡æ•°]
        H --> I{æ‹’ç»>=3æ¬¡?}
        I -->|æ˜¯| J[ä¸å†å±•ç¤ºBanner]
        I -->|å¦| K[ä¸‹æ¬¡æ—¶æœºå†å±•ç¤º]
    end

    subgraph ç»‘å®šæµç¨‹
        F --> L[è¾“å…¥æ‰‹æœºå·]
        L --> M[å‘é€éªŒè¯ç ]
        M --> N[è¾“å…¥éªŒè¯ç ]
        N --> O{éªŒè¯æˆåŠŸ?}
        O -->|æ˜¯| P[åˆå¹¶æ•°æ®]
        O -->|å¦| Q[æç¤ºé”™è¯¯]
        P --> R[ç»‘å®šå®Œæˆ]
    end
```

### 7.2 ç»‘å®šæµç¨‹è¯¦è§£

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯
    participant Auth as Supabase Auth
    participant DB as Supabase DB

    U->>FE: ç‚¹å‡»"ç»‘å®šæ‰‹æœºå·"
    FE->>U: å±•ç¤ºæ‰‹æœºå·è¾“å…¥æ¡†
    U->>FE: è¾“å…¥ 138xxxx1234
    FE->>Auth: POST /auth/otp {phone}
    Auth-->>FE: {message_id}
    FE->>U: å±•ç¤ºéªŒè¯ç è¾“å…¥æ¡†

    Note over U: æ”¶åˆ°çŸ­ä¿¡éªŒè¯ç 

    U->>FE: è¾“å…¥ 123456
    FE->>Auth: POST /auth/verify {phone, token}
    Auth-->>FE: {user, session}

    Note over FE: å¼€å§‹æ•°æ®åˆå¹¶

    FE->>DB: è·å– guest_data (by device_id)
    DB-->>FE: {profiles, watchlists, reviews...}
    FE->>DB: æ›´æ–° profiles.phone
    FE->>DB: æ›´æ–°æ‰€æœ‰å…³è”æ•°æ®çš„ user_id
    FE->>FE: åˆ é™¤ localStorage.device_id
    FE->>FE: å­˜å‚¨ session
    FE->>U: ç»‘å®šæˆåŠŸæç¤º
```

### 7.3 æ•°æ®åˆå¹¶é€»è¾‘

```sql
-- æ•°æ®åˆå¹¶å­˜å‚¨è¿‡ç¨‹
CREATE OR REPLACE FUNCTION merge_guest_to_user(
  p_guest_device_id TEXT,
  p_user_phone TEXT
)
RETURNS VOID AS $$
DECLARE
  v_guest_id UUID;
  v_user_id UUID;
BEGIN
  -- è·å–æ¸¸å®¢ID
  SELECT id INTO v_guest_id
  FROM profiles
  WHERE device_id = p_guest_device_id;

  -- è·å–æˆ–åˆ›å»ºæ­£å¼ç”¨æˆ·
  SELECT id INTO v_user_id
  FROM profiles
  WHERE phone = p_user_phone;

  IF v_user_id IS NULL THEN
    -- ç›´æ¥å‡çº§æ¸¸å®¢ä¸ºæ­£å¼ç”¨æˆ·
    UPDATE profiles
    SET phone = p_user_phone, device_id = NULL
    WHERE id = v_guest_id;
  ELSE
    -- åˆå¹¶æ•°æ®åˆ°å·²å­˜åœ¨ç”¨æˆ·
    UPDATE watchlists SET user_id = v_user_id WHERE user_id = v_guest_id;
    UPDATE review_logs SET user_id = v_user_id WHERE user_id = v_guest_id;
    UPDATE chat_sessions SET user_id = v_user_id WHERE user_id = v_guest_id;

    -- åˆå¹¶ investment_goals
    UPDATE profiles
    SET investment_goals = (
      SELECT ARRAY(
        SELECT DISTINCT unnest(investment_goals)
        FROM profiles
        WHERE id IN (v_guest_id, v_user_id)
      )
    )
    WHERE id = v_user_id;

    -- åˆ é™¤æ¸¸å®¢è®°å½•
    DELETE FROM profiles WHERE id = v_guest_id;
  END IF;
END;
$$ LANGUAGE plpgsql;
```

---

## 8. çŠ¶æ€æœºå®šä¹‰

### 8.1 ç”¨æˆ·çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> Guest: é¦–æ¬¡æ‰“å¼€
    Guest --> Onboarding: æ— device_id
    Onboarding --> Guest: å®Œæˆåˆå¿ƒè®¾å®š
    Guest --> Registered: ç»‘å®šæ‰‹æœºå·
    Registered --> Active: å®Œæˆ3æ¬¡å¯¹è¯
    Active --> Churned: 30å¤©æœªç™»å½•
    Churned --> Active: é‡æ–°ç™»å½•

    note right of Guest: device_idå­˜åœ¨\næœªç»‘å®šæ‰‹æœº
    note right of Registered: å·²ç»‘å®šæ‰‹æœº\nå¯¹è¯<3æ¬¡
    note right of Active: æ´»è·ƒç”¨æˆ·\nå¯¹è¯>=3æ¬¡
```

### 8.2 å¯¹è¯çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> Idle: è¿›å…¥å¯¹è¯é¡µ
    Idle --> Typing: ç”¨æˆ·è¾“å…¥/ç‚¹å‡»ç­¹ç 
    Typing --> Waiting: å‘é€æ¶ˆæ¯
    Waiting --> Responding: AIå¼€å§‹å“åº”
    Responding --> Idle: AIå®Œæˆå“åº”

    Idle --> CircuitBreaker: è§¦å‘ç†”æ–­
    CircuitBreaker --> Cooling: 30ç§’å†·é™
    Cooling --> ReasonInput: å†·é™ç»“æŸ
    ReasonInput --> Idle: æäº¤/è·³è¿‡ç†ç”±

    Idle --> Reviewing: ç‚¹å‡»è®°å½•
    Reviewing --> Idle: å®Œæˆå¤ç›˜

    note right of CircuitBreaker: è¿ç»­5è½®è´Ÿé¢æƒ…ç»ª
    note right of Cooling: è¾“å…¥æ¡†é”å®š
```

### 8.3 å¤ç›˜çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> NotStarted
    NotStarted --> MoodSelect: æ‰“å¼€å¤ç›˜Modal
    MoodSelect --> DecisionSelect: æ»‘åŠ¨å¿ƒæƒ…æ¡
    DecisionSelect --> NoteInput: é€‰æ‹©å†³ç­–
    NoteInput --> Submitting: ç‚¹å‡»æäº¤
    Submitting --> Success: APIæˆåŠŸ
    Submitting --> Failed: APIå¤±è´¥
    Success --> Rewarding: è®¡ç®—å¾½ç« 
    Rewarding --> [*]: å…³é—­Modal
    Failed --> NoteInput: é‡è¯•
```

---

## 9. é™„å½•

### 9.1 é¡µé¢è·¯ç”±è¡¨

| è·¯ç”± | é¡µé¢ | çŠ¶æ€è¦æ±‚ |
|------|------|---------|
| `/` | æ¸©åº¦é¦–é¡µ | å·²å®ŒæˆOnboarding |
| `/onboarding` | åˆå¿ƒè®¾å®š | æ— device_id |
| `/onboarding/watchlist` | å¿ƒç†é”šç‚¹ | å·²è®¾ç½®åˆå¿ƒ |
| `/chat` | å¯¹è¯é¡µ | å·²å®ŒæˆOnboarding |
| `/chat?symbol=NVDA` | èµ„äº§å¯¹è¯ | æºå¸¦èµ„äº§ä¸Šä¸‹æ–‡ |
| `/settings` | è®¾ç½®é¡µ | ä»»æ„ |
| `/settings/bindphone` | ç»‘å®šæ‰‹æœº | æ¸¸å®¢çŠ¶æ€ |

### 9.2 æœ¬åœ°å­˜å‚¨ç»“æ„

```typescript
// localStorage æ•°æ®ç»“æ„
interface LocalStorage {
  device_id?: string;           // æ¸¸å®¢UUID
  investment_goals?: string[];  // ç¦»çº¿æš‚å­˜
  pending_reviews?: ReviewLog[]; // ç¦»çº¿å¾…åŒæ­¥
  last_sync_at?: string;        // æœ€ååŒæ­¥æ—¶é—´
  banner_dismissed_count?: number; // ç»‘å®šBannerå…³é—­æ¬¡æ•°
}
```

### 9.3 åŸ‹ç‚¹äº‹ä»¶å®Œæ•´åˆ—è¡¨

| äº‹ä»¶å | è§¦å‘æ—¶æœº | å‚æ•° |
|--------|---------|------|
| `app_open` | æ‰“å¼€App | `is_returning` |
| `onboarding_start` | è¿›å…¥åˆå¿ƒè®¾å®š | - |
| `onboarding_goals_set` | è®¾ç½®æŠ•èµ„åˆå¿ƒ | `goals[]` |
| `onboarding_watchlist_add` | æ·»åŠ å¿ƒç†é”šç‚¹ | `symbol`, `market` |
| `onboarding_complete` | å®ŒæˆOnboarding | `duration_sec` |
| `home_view` | æŸ¥çœ‹é¦–é¡µ | `asset_count` |
| `fab_click` | ç‚¹å‡»FAB | - |
| `asset_card_click` | ç‚¹å‡»èµ„äº§å¡ç‰‡ | `symbol` |
| `emotion_chip_click` | ç‚¹å‡»æƒ…ç»ªç­¹ç  | `chip_type` |
| `message_send` | å‘é€æ¶ˆæ¯ | `has_chip`, `word_count` |
| `ai_response` | AIå“åº”å®Œæˆ | `response_time_ms` |
| `strategy_lock` | é”å®šå¯¹è¯ç­–ç•¥ | `strategy` |
| `circuit_breaker_trigger` | è§¦å‘ç†”æ–­ | `trigger_reason` |
| `circuit_breaker_complete` | ç†”æ–­ç»“æŸ | `reason_submitted` |
| `review_start` | å¼€å§‹å¤ç›˜ | `from_circuit_breaker` |
| `review_submit` | æäº¤å¤ç›˜ | `mood_change`, `decision` |
| `badge_earned` | è·å¾—å¾½ç«  | `badge_type` |
| `bind_banner_show` | å±•ç¤ºç»‘å®šBanner | `trigger_reason` |
| `bind_banner_click` | ç‚¹å‡»ç»‘å®šBanner | - |
| `bind_banner_dismiss` | å…³é—­ç»‘å®šBanner | `dismiss_count` |
| `bind_start` | å¼€å§‹ç»‘å®šæµç¨‹ | - |
| `bind_otp_sent` | å‘é€éªŒè¯ç  | - |
| `bind_success` | ç»‘å®šæˆåŠŸ | - |
| `bind_fail` | ç»‘å®šå¤±è´¥ | `error_code` |

---

**æ–‡æ¡£ç»“æŸ**

ğŸŒ¿ **ä¼´æŠ• Budvest - è®©æ¯ä¸€æ¬¡å¿ƒç†æ³¢åŠ¨éƒ½è¢«æ¸©æŸ”æ¥ä½**
